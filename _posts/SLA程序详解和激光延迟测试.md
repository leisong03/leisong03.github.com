# SLA程序详解和激光延迟测试

SLA主板在使用TTL激光器控制的时候遇到一个问题就是激光器无法精准控制延迟。目前的激光控制是伴随振镜步进进行的。

也就是说每进行一次脉冲步进才能进行一次激光的开关。按照目前TIM5的频率是40khz计算。激光延迟的最小单位是。
$$
\Delta = \frac{1}{f} = \frac{1}{40k} = 250\mu s
$$
这个延迟对于激光来说略微有点大？

所以需要在这个延迟的基础上将将激光的延迟开关周期增加到10us这个单位，也就是说需要将现在的控制精度提高100倍左右，目前的激光延迟是用一个`uint16_t`的变量存储的，我们需要将这个变量的长度修改为`uint32_t`。然后在TIM5的中断响应函数里面对额外加入的这些精度进行利用。

## 额外增加的16byte精度的利用

因为增加了16byte，理论上的精度是增加了65535倍，实际上我们用不了这么多，增加1000倍就可以了。增加TIM6时钟，使得

TIM6->PSC = 1000*TIM5->PSC;

TIM6的prescalar大了1000倍，所以脉冲宽度小1000倍。

然后将`laserDelay/1000`的值用作TIM5里面的计数器的值，将`laserDelay%1000`的值用作TIM6->ARR

将TIM6设置成One time的，在中断到时的时候切换激光的输出状态，使得激光能够被精确的开闭。大概就是这个意思。

## 修改后的控制协议

| 编号    | 类型      | 名称         | 备注   |
| ----- | ------- | ---------- | ---- |
| Byte0 | uint8_t | head       |      |
| Byte1 | uint8_t | seq        |      |
|       |         | ctrl       |      |
|       |         | laserDelay |      |
|       |         | posXY[2]   |      |
|       |         | stepCnt[2] |      |
|       |         | stepXY[2]  |      |
|       |         | stepPeriod |      |
|       |         |            |      |
|       |         |            |      |
|       |         |            |      |
|       |         |            |      |
|       |         |            |      |
|       |         |            |      |
|       |         |            |      |
|       |         |            |      |
|       |         |            |      |
|       |         |            |      |
|       |         |            |      |
|       |         |            |      |
|       |         |            |      |

